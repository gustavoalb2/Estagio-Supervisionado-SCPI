{% extends 'base.html' %}

{% block content %}
<div class="container-fluid tabela">
    <!-- Cabeçalho da tabela -->
    <div class="d-flex justify-content-between align-items-center mb-4 header-tabela">
        <div> 
            <h2 class="mb-1">{{ tabela.nome }}</h2>
            <p class="text-muted mb-0">{{ tabela.descricao }}</p>
        </div>
        <div class="d-flex gap-2">
            <form method="get" action="{% url 'tabela_processos' tabela.id %}" class="d-flex" role="search">
                <input class="form-control form-control-sm" type="search" name="q" placeholder="Procurar Processo" aria-label="Procurar" value="{{ request.GET.q }}">
                <button class="btn btn-sm btn-primary ms-1" type="submit">Procurar</button>
            </form>
            <a href="{% url 'exportar_processos_xlsx' tabela.id %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-upload"></i> Exportar Excel
            </a>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importarModal">
                <i class="bi bi-download"></i> Importar
            </button>
            <a href="{% url 'adicionar_processo_tabela' tabela.id %}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus"></i> Novo Processo
            </a>
        </div>
    </div>

    <!-- Modal de Importação -->
    <div class="modal fade" id="importarModal" tabindex="-1" aria-labelledby="importarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importarModalLabel">Importar Processos de Planilha Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'importar_processos' tabela.id %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="excel_file" class="form-label">Selecione o arquivo Excel (.xlsx)</label>
                            <input class="form-control" type="file" id="excel_file" name="excel_file" accept=".xlsx" required>
                            <div class="form-text mt-2">
                                <strong>Formato esperado:</strong>
                                <p>A planilha deve conter as seguintes colunas (na ordem):</p>
                                <ol>
                                    <li>Nome (obrigatório)</li>
                                    <li>Matrícula</li>
                                    <li>Número do Processo</li>
                                    <li>Data de Abertura</li>
                                    <li>Data de Retorno</li>
                                    <li>Setor (CIC ou DPQ)</li>
                                    <li>Bolsa (Sim ou Não)</li>
                                    <li>Status (Em Andamento ou Concluído)</li>
                                    <li>Assunto</li>
                                    <li>Observações</li>
                                </ol>
                                <p class="text-muted small">A primeira linha deve conter os cabeçalhos. Processos com números duplicados serão ignorados.</p>
                                <div class="alert alert-info">
                                    <strong>Nota:</strong> A planilha pode conter cabeçalhos com nomes diferentes, desde que estejam na ordem correta. Se houver cabeçalhos, o sistema tentará mapear automaticamente os campos.
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Importar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Tabela -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Nome <i class="bi bi-arrow-down"></i></th>
                    <th>Matrícula <i class="bi bi-arrow-down"></i></th>
                    <th>Nº processo <i class="bi bi-arrow-down"></i></th>
                    <th>Data de abertura <i class="bi bi-arrow-down"></i></th>
                    <th>Data de retorno <i class="bi bi-arrow-down"></i></th>
                    <th>Setor <i class="bi bi-arrow-down"></i></th>
                    <th>Bolsa <i class="bi bi-arrow-down"></i></th>
                    <th>Status <i class="bi bi-arrow-down"></i></th>
                    <th>Assunto <i class="bi bi-arrow-down"></i></th>
                    <th class="col-acoes">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for processo in processos %}
                <tr>
                    <td><strong>{{ processo.nome }}</strong></td>
                    <td class="text-muted">{{ processo.matricula }}</td>
                    <td class="text-muted col-numero-processo">{{ processo.numero_processo }}</td>
                    <td class="text-muted col-data-abertura">{{ processo.data_abertura|date:"d/m/Y" }}</td>
                    <td class="text-muted col-data-retorno">{{ processo.data_retorno|date:"d/m/Y" }}</td>
                    <td class="text-muted col-setor">{{ processo.setor }}</td>
                    <td class="col-bolsa">
                        {% if processo.bolsa == 'Sim' %}
                            <span class="badge bg-success">Sim</span>
                        {% else %}
                            <span class="badge bg-danger">Não</span>
                        {% endif %}
                    </td>
                    <td class="col-status">
                        {% if processo.status == 'concluido' %}
                            <span class="badge bg-success">Concluído</span>
                        {% elif processo.status == 'em_andamento' %}
                            <span class="badge bg-warning">Em andamento</span>
                        {% else %}
                            <span class="badge bg-info">{{ processo.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td class="col-assunto">{{ processo.assunto }}</td>
                    <td class="col-acoes">
                        <button type="button" class="btn btn-outline-info btn-sm btn-visualizar" data-bs-toggle="modal" data-bs-target="#observacoesModal{{ processo.id }}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <a href="{% url 'editar_processo' processo.id %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <form action="{% url 'deletar_processo' processo.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Tem certeza que deseja deletar este processo?');">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <br>
                        Nenhum processo encontrado.
                        <br>
                        <small>Clique em "Novo Processo" para adicionar o primeiro.</small>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modais de Observações -->
    {% for processo in processos %}
    <div class="modal fade" id="observacoesModal{{ processo.id }}" tabindex="-1" aria-labelledby="observacoesModalLabel{{ processo.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="observacoesModalLabel{{ processo.id }}">Observações do Processo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <strong>Processo: </strong>{{ processo.numero_processo }}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ processo.nome }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ processo.get_status_display }}</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Matrícula:</strong> {{ processo.matricula|default:"Não informada" }}</p>
                                    <p><strong>Data de Abertura:</strong> {{ processo.data_abertura|date:"d/m/Y"|default:"Não informada" }}</p>
                                    <p><strong>Setor:</strong> {{ processo.get_setor_display|default:"Não informado" }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Bolsa:</strong> {{ processo.get_bolsa_display|default:"Não informada" }}</p>
                                    <p><strong>Data de Retorno:</strong> {{ processo.data_retorno|date:"d/m/Y"|default:"Não informada" }}</p>
                                    <p><strong>Status:</strong> {{ processo.get_status_display|default:"Não informado" }}</p>
                                </div>
                            </div>
                            <p class="card-text"><strong>Assunto:</strong> {{ processo.assunto|default:"Não informado" }}</p>
                            <div class="border p-3 bg-light rounded">
                                <h6>Observações:</h6>
                                <p class="mb-0">{% if processo.observacoes %}{{ processo.observacoes|linebreaksbr }}{% else %}Nenhuma observação cadastrada.{% endif %}</p>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                {% if processo.data_criacao %}
                                    Última atualização: {{ processo.data_criacao|date:"d/m/Y H:i" }}
                                {% else %}
                                    Sem informação de data de atualização
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Informações Adicionais -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Informações adicionais</h5>
            <p class="card-text">Processos CIC: {{ count_cic }} processos listados</p>
            <p class="card-text">Processos DPQ: {{ count_dpq }} processos listados</p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<style>
.tabela {
    margin-top: 1em;
    margin-bottom: 1em;
}
.header-tabela {
    padding-bottom: 0.1em;
}
.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 1;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

.badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.form-check-input:disabled {
    opacity: 0.3;
}

.bi-arrow-down {
    font-size: 0.75rem;
    color: #6c757d;
}

.table-responsive {
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    max-height: 25em;  /*Defina a altura máxima que desejar */
    overflow-y: auto; /* Adiciona a barra de rolagem vertical */
}

.col-assunto {
    width: 15%;
    white-space: normal;
    word-break: break-word;
}

.col-data-abertura,
.col-data-retorno,
.col-numero-processo {
    width: 10%;
}
.col-acoes {
    width: 8%;
    text-align: center;
}
.col-status,
.col-bolsa,
.col-setor {
    width: 5%;
}

.card-body {
    background-color: #f8f9fa;
}
.card-body p {
    margin: 0;  
}

/* Estilo para o botão de visualizar observações */
.btn-outline-info:hover {
    background-color: #0dcaf0;
    color: #fff;
}

/* Estilo para o modal de observações */
.modal-body .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.modal-body .border {
    background-color: #f8f9fa;
    border-color: #dee2e6 !important;
}

/* Tooltip para ícones */
[data-bs-toggle="tooltip"] {
    cursor: pointer;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar todos os modais
        var modais = document.querySelectorAll('.modal');
        modais.forEach(function(modal) {
            new bootstrap.Modal(modal);
        });
        
        // Adicionar tooltips apenas aos botões de editar e excluir
        document.querySelectorAll('.col-acoes .btn:not(.btn-visualizar)').forEach(function(btn) {
            if (btn.querySelector('.bi-pencil')) {
                btn.setAttribute('data-bs-toggle', 'tooltip');
                btn.setAttribute('data-bs-placement', 'top');
                btn.setAttribute('title', 'Editar Processo');
            } else if (btn.querySelector('.bi-trash')) {
                btn.setAttribute('data-bs-toggle', 'tooltip');
                btn.setAttribute('data-bs-placement', 'top');
                btn.setAttribute('title', 'Excluir Processo');
            }
        });
        
        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Adicionar título aos botões de visualizar sem interferir no modal
        document.querySelectorAll('.btn-visualizar').forEach(function(btn) {
            // Apenas adicionamos o atributo title sem mudar o data-bs-toggle
            btn.setAttribute('title', 'Visualizar Observações');
        });
    });
</script>
{% endblock %}